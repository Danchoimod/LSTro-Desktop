<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Hệ thống Quản lý Lưu trú - Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#09b4d3",
                        "background-light": "#f5f8f8",
                        "background-dark": "#101f22",
                    },
                    fontFamily: {
                        "display": ["Inter"]
                    },
                    borderRadius: { "DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .sidebar-active {
            background-color: rgba(9, 180, 211, 0.1);
            color: #09b4d3;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        /* Dropdown Styles for Address */
        .dropdown-wrapper {
            position: relative;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #09b4d3;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }

        .dropdown-list.show {
            display: block;
        }

        .dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid #f3f4f6;
            font-size: 13px;
        }

        .dropdown-item:hover {
            background: rgba(9, 180, 211, 0.05);
        }

        .dropdown-item mark {
            background: #fef08a;
            font-weight: 600;
        }

        /* Pulse for processing status */
        @keyframes pulse-soft {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .animate-pulse-soft {
            animation: pulse-soft 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Context Menu Styles */
        .context-menu {
            position: fixed;
            z-index: 1000;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 4px;
            min-width: 180px;
            display: none;
        }

        .context-menu-item {
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 500;
            color: #475569;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .context-menu-item:hover {
            background-color: rgba(9, 180, 211, 0.05);
            color: #09b4d3;
        }

        .context-menu-item.danger:hover {
            background-color: #fef2f2;
            color: #ef4444;
        }

        .context-menu-item .material-symbols-outlined {
            font-size: 18px;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 overflow-hidden h-screen flex flex-col">
    <!-- Top Navigation Bar -->
    <header
        class="h-16 border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-background-dark flex items-center justify-between px-6 shrink-0 z-10">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2 text-primary">
                <span class="material-symbols-outlined text-3xl font-bold">domain</span>
                <h2 class="text-lg font-bold tracking-tight text-slate-800 dark:text-white">Residence Manager</h2>
            </div>
            <div class="h-8 w-[1px] bg-slate-200 dark:bg-slate-700 mx-2"></div>
            <div class="flex items-center gap-2 text-sm font-medium text-slate-600 dark:text-slate-400">
                <span class="material-symbols-outlined text-lg">location_on</span>
                <select id="branchSelect" onchange="onBranchChange()"
                    class="bg-transparent border-none focus:ring-0 cursor-pointer p-0 text-sm font-semibold">
                    <option value="1">Tâm An 1 - Long Tuyền</option>
                    <option value="2">Tâm An 2 - Long Tuyền</option>
                </select>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 px-3 py-1.5 rounded-full">
                <span class="material-symbols-outlined text-green-500 text-sm">cloud_done</span>
                <span class="text-xs font-medium text-slate-500 dark:text-slate-400" id="syncStatus">Synced now</span>
            </div>
            <button onclick="showDateModal()"
                class="flex items-center justify-center p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors"
                title="Chỉnh ngày lưu trú">
                <span class="material-symbols-outlined">calendar_month</span>
            </button>
            <input type="file" id="importFile" class="hidden" accept=".json" onchange="importJSON(event)">
            <button onclick="document.getElementById('importFile').click()"
                class="flex items-center justify-center p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors"
                title="Nhập JSON">
                <span class="material-symbols-outlined">upload_file</span>
            </button>
            <button onclick="exportJSON()"
                class="flex items-center justify-center p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition-colors"
                title="Xuất JSON">
                <span class="material-symbols-outlined">download</span>
            </button>
            <div class="h-8 w-8 rounded-full bg-slate-200 dark:bg-slate-700 bg-cover bg-center border-2 border-white dark:border-slate-800"
                style="background-image: url('https://ui-avatars.com/api/?name=Admin&background=09b4d3&color=fff')">
            </div>
        </div>
    </header>

    <!-- Main Layout Container -->
    <main class="flex flex-1 overflow-hidden">
        <!-- Sidebar Navigation (Slim) -->
        <nav
            class="w-16 flex flex-col items-center py-4 gap-4 border-r border-slate-200 dark:border-slate-800 bg-white dark:bg-background-dark shrink-0">
            <button class="sidebar-active p-3 rounded-xl transition-colors" title="Registration">
                <span class="material-symbols-outlined text-2xl">person_add</span>
            </button>
            <button class="p-3 text-slate-400 hover:text-primary transition-colors" title="History">
                <span class="material-symbols-outlined text-2xl">history</span>
            </button>
            <button class="p-3 text-slate-400 hover:text-primary transition-colors" title="Analytics">
                <span class="material-symbols-outlined text-2xl">bar_chart</span>
            </button>
            <div class="mt-auto flex flex-col gap-4">
                <button class="p-3 text-slate-400 hover:text-primary transition-colors" title="Help">
                    <span class="material-symbols-outlined text-2xl">help</span>
                </button>
                <button class="p-3 text-slate-400 hover:text-primary transition-colors" title="Settings">
                    <span class="material-symbols-outlined text-2xl">settings</span>
                </button>
            </div>
        </nav>

        <!-- Entry List Pane -->
        <aside
            class="w-80 border-r border-slate-200 dark:border-slate-800 bg-white dark:bg-background-dark flex flex-col shrink-0">
            <!-- Search & Tabs -->
            <div class="p-4 border-b border-slate-100 dark:border-slate-800">
                <div class="relative mb-4">
                    <span
                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg">search</span>
                    <input
                        class="w-full bg-slate-100 dark:bg-slate-800 border-none rounded-lg pl-10 py-2 text-sm focus:ring-2 focus:ring-primary/20"
                        placeholder="Search guests..." type="text" id="guestSearch" oninput="renderTable()" />
                </div>
                <div class="flex gap-4">
                    <button class="text-sm font-bold border-b-2 border-primary pb-2 text-slate-800 dark:text-white">Danh
                        sách</button>
                    <button onclick="clearAll()"
                        class="text-sm font-medium text-red-400 pb-2 hover:text-red-600 ml-auto">Xóa sạch</button>
                </div>
            </div>
            <!-- List Content -->
            <div class="flex-1 overflow-y-auto" id="guestTable">
                <!-- Guests will be injected here -->
                <div id="emptyRow" class="p-8 text-center text-slate-400">
                    <span class="material-symbols-outlined text-4xl mb-2 opacity-20">inbox</span>
                    <p class="text-xs">Chưa có dữ liệu</p>
                </div>
            </div>
            <!-- New Entry Button -->
            <div class="p-4 bg-white dark:bg-background-dark border-t border-slate-100 dark:border-slate-800">
                <button id="sendBtn" onclick="sendToPython()"
                    class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 transition-all shadow-lg shadow-primary/20 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="material-symbols-outlined">send</span>
                    GỬI TRÌNH DUYỆT (<span id="count">0</span>)
                </button>
            </div>
        </aside>

        <!-- Detail Content Area -->
        <div class="flex-1 overflow-y-auto bg-slate-50 dark:bg-slate-900/50 p-8">
            <div class="max-w-4xl mx-auto space-y-6">
                <form id="guestForm" onsubmit="event.preventDefault(); saveGuest();">
                    <input type="hidden" id="editIndex" value="-1">
                    <!-- Form Header -->
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h1 class="text-2xl font-bold text-slate-800 dark:text-white mb-1" id="formTitle">Residence
                                Registration</h1>
                            <p class="text-sm text-slate-500">Thông tin đăng ký khách lưu trú với công an địa phương.
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button type="button" id="btnCancelEdit" onclick="cancelEdit()"
                                class="hidden bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-4 py-2 rounded-lg text-sm font-semibold text-slate-700 dark:text-slate-300 hover:bg-slate-50 transition-colors">Hủy
                                sửa</button>
                            <button type="submit"
                                class="bg-primary text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-primary/90 transition-all flex items-center gap-2 shadow-lg shadow-primary/10">
                                <span class="material-symbols-outlined text-lg" id="submitIcon">add</span>
                                <span id="submitBtnText">Thêm khách mới</span>
                            </button>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- Section 1: Personal Info -->
                        <div
                            class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                            <div
                                class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/50 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary text-xl">badge</span>
                                <h3 class="font-bold text-slate-700 dark:text-slate-200 text-sm">Thông tin cá nhân</h3>
                            </div>
                            <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="flex flex-col gap-1.5 lg:col-span-2">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Họ và
                                        tên</label>
                                    <input id="ho_ten" name="ho_ten"
                                        class="border-slate-200 dark:border-slate-700 dark:bg-slate-900 rounded-lg focus:ring-primary focus:border-primary text-sm uppercase font-semibold"
                                        type="text" placeholder="NGUYEN VAN A" required />
                                </div>
                                <div class="flex flex-col gap-1.5">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Số CCCD
                                        / Hộ chiếu</label>
                                    <input id="cccd" name="cccd"
                                        class="border-slate-200 dark:border-slate-700 dark:bg-slate-900 rounded-lg focus:ring-primary focus:border-primary text-sm font-mono"
                                        type="text" placeholder="0XXXXXXX" required />
                                </div>
                                <div class="flex flex-col gap-1.5">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Ngày
                                        sinh</label>
                                    <input id="ngay_birth" name="ngay_birth"
                                        class="border-slate-200 dark:border-slate-700 dark:bg-slate-900 rounded-lg focus:ring-primary focus:border-primary text-sm"
                                        type="text" placeholder="DD/MM/YYYY" required />
                                </div>
                                <div class="flex flex-col gap-1.5">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Giới
                                        tính</label>
                                    <select id="gioi_tinh" name="gioi_tinh"
                                        class="border-slate-200 dark:border-slate-700 dark:bg-slate-900 rounded-lg focus:ring-primary focus:border-primary text-sm">
                                        <option value="Nam">Nam</option>
                                        <option value="Nữ">Nữ</option>
                                    </select>
                                </div>
                                <div class="flex flex-col gap-1.5">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Quốc
                                        tịch</label>
                                    <input id="quoc_tich" name="quoc_tich"
                                        class="border-slate-200 dark:border-slate-700 dark:bg-slate-900 rounded-lg focus:ring-primary focus:border-primary text-sm"
                                        type="text" value="Việt Nam" />
                                </div>
                                <div class="flex flex-col gap-1.5">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Dân
                                        tộc</label>
                                    <input id="dan_toc" name="dan_toc"
                                        class="border-slate-200 dark:border-slate-700 dark:bg-slate-900 rounded-lg focus:ring-primary focus:border-primary text-sm"
                                        type="text" value="Kinh" />
                                </div>
                                <div class="flex flex-col gap-1.5">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Nghề
                                        nghiệp</label>
                                    <input id="nghe_nghiep" name="nghe_nghiep"
                                        class="border-slate-200 dark:border-slate-700 dark:bg-slate-900 rounded-lg focus:ring-primary focus:border-primary text-sm"
                                        type="text" value="Tự do" />
                                </div>
                                <div class="flex flex-col gap-1.5">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Nơi làm
                                        việc</label>
                                    <input id="noi_lam_viec" name="noi_lam_viec"
                                        class="border-slate-200 dark:border-slate-700 dark:bg-slate-900 rounded-lg focus:ring-primary focus:border-primary text-sm"
                                        type="text" value="Tự do" />
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Address -->
                        <div
                            class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                            <div
                                class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/50 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary text-xl">home_pin</span>
                                <h3 class="font-bold text-slate-700 dark:text-slate-200 text-sm">Địa chỉ thường trú</h3>
                            </div>
                            <div class="p-6 space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="flex flex-col gap-1.5 dropdown-wrapper">
                                        <label
                                            class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Tỉnh /
                                            Thành phố</label>
                                        <input id="tinh" name="tinh" oninput="onTinhInput(event)"
                                            onfocus="onTinhFocus()"
                                            class="border-slate-200 dark:border-slate-700 dark:bg-slate-900 rounded-lg focus:ring-primary focus:border-primary text-sm"
                                            type="text" placeholder="Tìm tỉnh/thành..." autocomplete="off" />
                                        <div id="tinhDropdown" class="dropdown-list"></div>
                                    </div>
                                    <div class="flex flex-col gap-1.5 dropdown-wrapper">
                                        <label
                                            class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Quận /
                                            Huyện / Xã</label>
                                        <input id="xa" name="xa" oninput="onXaInput(event)" onfocus="onXaFocus()"
                                            class="border-slate-200 dark:border-slate-700 dark:bg-slate-900 rounded-lg focus:ring-primary focus:border-primary text-sm"
                                            type="text" placeholder="Tìm quận/huyện/xã..." autocomplete="off" />
                                        <div id="xaDropdown" class="dropdown-list"></div>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-1.5">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Số nhà,
                                        tên đường, tổ/ấp</label>
                                    <input id="dia_chi_chi_tiet" name="dia_chi_chi_tiet"
                                        class="border-slate-200 dark:border-slate-700 dark:bg-slate-900 rounded-lg focus:ring-primary focus:border-primary text-sm w-full"
                                        type="text" placeholder="VD: 123 Lê Lợi, Ấp Bình Tây..." />
                                </div>
                            </div>
                        </div>

                        <!-- Section 3: Stay Details -->
                        <div
                            class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                            <div
                                class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/50 flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary text-xl">hotel</span>
                                <h3 class="font-bold text-slate-700 dark:text-slate-200 text-sm">Chi tiết lưu trú</h3>
                            </div>
                            <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div class="flex flex-col gap-1.5">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Số
                                        phòng</label>
                                    <input id="so_phong" name="so_phong"
                                        class="border-slate-200 dark:border-slate-700 dark:bg-slate-900 rounded-lg focus:ring-primary focus:border-primary text-sm font-bold text-primary"
                                        type="text" placeholder="VD: 302" />
                                </div>
                                <div class="flex flex-col gap-1.5">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Ngày
                                        đến</label>
                                    <input id="thoi_gian_luu_tru" name="thoi_gian_luu_tru"
                                        class="border-slate-200 dark:border-slate-700 dark:bg-slate-900 rounded-lg focus:ring-primary focus:border-primary text-sm"
                                        type="text" placeholder="DD/MM/YYYY" />
                                </div>
                                <div class="flex flex-col gap-1.5">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Ngày đi
                                        (dự kiến)</label>
                                    <input id="luu_tru_den" name="luu_tru_den"
                                        class="border-slate-200 dark:border-slate-700 dark:bg-slate-900 rounded-lg focus:ring-primary focus:border-primary text-sm"
                                        type="text" placeholder="DD/MM/YYYY" />
                                </div>
                                <div class="lg:col-span-3 flex flex-col gap-1.5">
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Lý do
                                        lưu trú</label>
                                    <textarea id="ly_do" name="ly_do"
                                        class="border-slate-200 dark:border-slate-700 dark:bg-slate-900 rounded-lg focus:ring-primary focus:border-primary text-sm"
                                        rows="2">Đi học/Làm việc</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Modals (Branch Selection) -->
    <div id="branchModal" class="fixed inset-0 modal-backdrop z-[100] hidden items-center justify-center">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                    <span class="material-symbols-outlined text-3xl text-primary">apartment</span>
                </div>
                <h3 class="text-xl font-bold text-slate-800 dark:text-white">Chọn Chi Nhánh</h3>
                <p class="text-slate-500 text-sm mt-1">Vui lòng chọn cơ sở lưu trú của bạn</p>
            </div>
            <div class="space-y-3">
                <button onclick="selectBranch('1')"
                    class="w-full p-4 bg-slate-50 dark:bg-slate-700 hover:bg-primary/10 border border-slate-200 dark:border-slate-600 rounded-xl transition flex items-center gap-3">
                    <span class="material-symbols-outlined text-primary">hotel</span>
                    <span class="font-semibold text-sm">Hộ Kinh Doanh Tâm An 1</span>
                    <span class="material-symbols-outlined ml-auto text-slate-400">chevron_right</span>
                </button>
                <button onclick="selectBranch('2')"
                    class="w-full p-4 bg-slate-50 dark:bg-slate-700 hover:bg-primary/10 border border-slate-200 dark:border-slate-600 rounded-xl transition flex items-center gap-3">
                    <span class="material-symbols-outlined text-primary">hotel</span>
                    <span class="font-semibold text-sm">NHÀ TRỌ TÂM AN 2</span>
                    <span class="material-symbols-outlined ml-auto text-slate-400">chevron_right</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ngày Lưu Trú -->
    <div id="dateModal" class="fixed inset-0 modal-backdrop z-[100] hidden items-center justify-center">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold">Chỉnh Ngày Batch</h3>
                <button onclick="hideDateModal()" class="text-slate-400"><span
                        class="material-symbols-outlined">close</span></button>
            </div>
            <div class="space-y-4">
                <div class="flex flex-col gap-1.5">
                    <label class="text-[10px] font-bold uppercase text-slate-500">Từ ngày</label>
                    <input type="text" id="modalStartDate"
                        class="border-slate-200 dark:border-slate-700 dark:bg-slate-900 rounded-lg p-2 text-sm"
                        placeholder="DD/MM/YYYY">
                </div>
                <div class="flex flex-col gap-1.5">
                    <label class="text-[10px] font-bold uppercase text-slate-500">Đến ngày</label>
                    <input type="text" id="modalEndDate"
                        class="border-slate-200 dark:border-slate-700 dark:bg-slate-900 rounded-lg p-2 text-sm"
                        placeholder="DD/MM/YYYY">
                </div>
                <button onclick="applyDatesToAll()"
                    class="w-full bg-primary text-white py-3 rounded-xl font-bold mt-4 shadow-lg shadow-primary/20">Cập
                    nhật <span id="totalGuests">0</span> khách</button>
            </div>
        </div>
    </div>

    <!-- Modal Xác Nhận Gửi -->
    <div id="sendConfirmModal" class="fixed inset-0 modal-backdrop z-[100] hidden items-center justify-center">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <div
                    class="bg-blue-50 dark:bg-blue-900/30 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                    <span class="material-symbols-outlined text-3xl text-primary">rocket_launch</span>
                </div>
                <h3 class="text-xl font-bold">Xác nhận gửi dữ liệu</h3>
                <p class="text-sm text-slate-500 mt-1">Gửi dữ liệu đã chọn đến trình duyệt automation</p>
            </div>

            <div class="bg-slate-50 dark:bg-slate-900/50 rounded-xl p-4 mb-6 grid grid-cols-2 gap-4">
                <div>
                    <p class="text-[10px] uppercase font-bold text-slate-400">Tổng số khách</p>
                    <p class="text-2xl font-bold text-primary" id="totalCount">0</p>
                </div>
                <div>
                    <p class="text-[10px] uppercase font-bold text-slate-400">Số khách lỗi</p>
                    <p class="text-2xl font-bold text-red-500" id="errorCount">0</p>
                </div>
            </div>

            <div class="space-y-2">
                <button onclick="sendRetry()" id="btnRetry"
                    class="w-full p-4 bg-orange-500 hover:bg-orange-600 text-white rounded-xl font-bold transition flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">restart_alt</span>Gửi lại khách lỗi
                </button>
                <button onclick="sendNew()"
                    class="w-full p-4 bg-primary hover:bg-primary/90 text-white rounded-xl font-bold transition flex items-center justify-center gap-2 shadow-lg shadow-primary/20">
                    <span class="material-symbols-outlined">send</span>Gửi mới toàn bộ
                </button>
                <button onclick="cancelSend()"
                    class="w-full p-3 text-slate-500 hover:text-slate-700 font-semibold transition">Hủy</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" onclick="sendIndividualFromMenu()">
            <span class="material-symbols-outlined text-primary">send</span>
            <span>Gửi người này</span>
        </div>
        <div class="context-menu-item" onclick="editFromMenu()">
            <span class="material-symbols-outlined text-amber-500">edit</span>
            <span>Sửa thông tin</span>
        </div>
        <div class="h-[1px] bg-slate-100 my-1"></div>
        <div class="context-menu-item danger" onclick="removeFromMenu()">
            <span class="material-symbols-outlined text-red-500">delete</span>
            <span>Xóa khách</span>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        let guestList = [];
        let selectedBranch = localStorage.getItem('selectedBranch') || null;

        // Dữ liệu địa chỉ từ API
        let provincesData = [];
        let wardsData = [];

        window.addEventListener('DOMContentLoaded', function () {
            if (!selectedBranch) {
                showBranchModal();
            } else {
                document.getElementById('branchSelect').value = selectedBranch;
            }
            loadProvinces();

            // Set default dates for today
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const yyyy = today.getFullYear();
            const dateStr = `${dd}/${mm}/${yyyy}`;
            document.getElementById('thoi_gian_luu_tru').value = dateStr;
            document.getElementById('luu_tru_den').value = dateStr;
        });

        function showBranchModal() {
            const modal = document.getElementById('branchModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideBranchModal() {
            const modal = document.getElementById('branchModal');
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }

        function selectBranch(branchValue) {
            selectedBranch = branchValue;
            localStorage.setItem('selectedBranch', branchValue);
            document.getElementById('branchSelect').value = branchValue;
            hideBranchModal();
            notifyBranchChange(branchValue);
        }

        function onBranchChange() {
            selectedBranch = document.getElementById('branchSelect').value;
            localStorage.setItem('selectedBranch', selectedBranch);
            notifyBranchChange(selectedBranch);
        }

        async function notifyBranchChange(branchValue) {
            try {
                const response = await fetch('http://127.0.0.1:8000/set-branch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ branch: branchValue })
                });
            } catch (error) {
                console.error('Lỗi kết nối:', error);
            }
        }

        function showDateModal() {
            if (guestList.length === 0) return alert('Danh sách trống!');
            const modal = document.getElementById('dateModal');
            document.getElementById('totalGuests').textContent = guestList.length;
            if (guestList.length > 0) {
                document.getElementById('modalStartDate').value = guestList[0].thoi_gian_luu_tru || '';
                document.getElementById('modalEndDate').value = guestList[0].luu_tru_den || '';
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideDateModal() {
            const modal = document.getElementById('dateModal');
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }

        function applyDatesToAll() {
            const startDate = document.getElementById('modalStartDate').value.trim();
            const endDate = document.getElementById('modalEndDate').value.trim();
            if (!startDate || !endDate) return alert('Nhập đủ ngày!');

            guestList.forEach(guest => {
                guest.thoi_gian_luu_tru = startDate;
                guest.luu_tru_den = endDate;
            });
            renderTable();
            hideDateModal();
        }

        function saveGuest() {
            const form = document.getElementById('guestForm');
            const editIndex = parseInt(document.getElementById('editIndex').value);

            const ho_ten = document.getElementById('ho_ten').value.toUpperCase().trim();
            const cccd = document.getElementById('cccd').value.trim();
            const ngay_birth = document.getElementById('ngay_birth').value.trim();

            if (!ho_ten || !cccd || !ngay_birth) {
                alert("Vui lòng nhập đủ Họ tên, CCCD và Ngày sinh!");
                return;
            }

            const guest = {
                ho_ten,
                cccd,
                ngay_birth,
                gioi_tinh: document.getElementById('gioi_tinh').value,
                quoc_gia: "Cộng hòa xã hội chủ nghĩa Việt Nam",
                quoc_tich: document.getElementById('quoc_tich').value,
                dan_toc: document.getElementById('dan_toc').value,
                noi_lam_viec: document.getElementById('noi_lam_viec').value,
                nghe_nghiep: document.getElementById('nghe_nghiep').value,
                so_phong: document.getElementById('so_phong').value.trim(),
                tinh: document.getElementById('tinh').value.trim(),
                xa: document.getElementById('xa').value.trim(),
                dia_chi_chi_tiet: document.getElementById('dia_chi_chi_tiet').value.trim(),
                ly_do: document.getElementById('ly_do').value,
                thoi_gian_luu_tru: document.getElementById('thoi_gian_luu_tru').value,
                luu_tru_den: document.getElementById('luu_tru_den').value,
                status: editIndex > -1 ? guestList[editIndex].status : 'PENDING'
            };

            if (editIndex > -1) {
                guestList[editIndex] = guest;
                cancelEdit();
            } else {
                guestList.push(guest);
                resetFormFields();
            }
            renderTable();
        }

        function editGuest(index) {
            const guest = guestList[index];
            document.getElementById('editIndex').value = index;

            document.getElementById('ho_ten').value = guest.ho_ten;
            document.getElementById('cccd').value = guest.cccd;
            document.getElementById('ngay_birth').value = guest.ngay_birth;
            document.getElementById('gioi_tinh').value = guest.gioi_tinh;
            document.getElementById('so_phong').value = guest.so_phong;
            document.getElementById('dan_toc').value = guest.dan_toc;
            document.getElementById('quoc_tich').value = guest.quoc_tich;
            document.getElementById('nghe_nghiep').value = guest.nghe_nghiep;
            document.getElementById('noi_lam_viec').value = guest.noi_lam_viec;
            document.getElementById('tinh').value = guest.tinh;
            document.getElementById('xa').value = guest.xa;
            document.getElementById('dia_chi_chi_tiet').value = guest.dia_chi_chi_tiet;
            document.getElementById('ly_do').value = guest.ly_do;
            document.getElementById('thoi_gian_luu_tru').value = guest.thoi_gian_luu_tru;
            document.getElementById('luu_tru_den').value = guest.luu_tru_den;

            document.getElementById('formTitle').innerText = "Chỉnh sửa khách";
            document.getElementById('submitBtnText').innerText = "Cập nhật";
            document.getElementById('submitIcon').innerText = "edit";
            document.getElementById('btnCancelEdit').classList.remove('hidden');

            // Highlight selected row in sidebar
            renderTable();
        }

        function cancelEdit() {
            document.getElementById('editIndex').value = "-1";
            resetFormFields();
            document.getElementById('formTitle').innerText = "Residence Registration";
            document.getElementById('submitBtnText').innerText = "Thêm khách mới";
            document.getElementById('submitIcon').innerText = "add";
            document.getElementById('btnCancelEdit').classList.add('hidden');
            renderTable();
        }

        function resetFormFields() {
            const ho_ten_el = document.getElementById('ho_ten');
            ho_ten_el.value = '';
            document.getElementById('cccd').value = '';
            document.getElementById('ngay_birth').value = '';
            ho_ten_el.focus();
        }

        function renderTable() {
            const container = document.getElementById('guestTable');
            const countEl = document.getElementById('count');
            const editIndex = parseInt(document.getElementById('editIndex').value);
            const search = document.getElementById('guestSearch').value.toLowerCase();

            if (guestList.length === 0) {
                container.innerHTML = `
                    <div id="emptyRow" class="p-8 text-center text-slate-400">
                        <span class="material-symbols-outlined text-4xl mb-2 opacity-20">inbox</span>
                        <p class="text-xs">Chưa có dữ liệu</p>
                    </div>`;
            } else {
                container.innerHTML = '';
                guestList.forEach((g, index) => {
                    if (search && !g.ho_ten.toLowerCase().includes(search) && !g.cccd.includes(search)) return;

                    let statusDot = 'bg-slate-300';
                    let statusLabel = 'Chờ gửi';
                    let statusColor = 'text-slate-400';
                    let rowBorder = 'border-transparent';
                    let rowBg = 'hover:bg-slate-50';

                    if (g.status === 'PROCESSING') {
                        statusDot = 'bg-primary animate-pulse-soft';
                        statusLabel = 'Đang nhập...';
                        statusColor = 'text-primary';
                    } else if (g.status === 'COMPLETED') {
                        statusDot = 'bg-green-500';
                        statusLabel = 'Thành công';
                        statusColor = 'text-green-500';
                    } else if (g.status === 'ERROR') {
                        statusDot = 'bg-red-500';
                        statusLabel = 'Lỗi / Bỏ qua';
                        statusColor = 'text-red-500';
                    }

                    if (index === editIndex) {
                        rowBg = 'bg-primary/5';
                        rowBorder = 'border-primary';
                    }

                    const item = document.createElement('div');
                    item.className = `flex items-center gap-3 p-4 border-l-4 cursor-pointer transition-colors border-b border-slate-50 dark:border-slate-800/50 ${rowBg} ${rowBorder}`;

                    // Click to edit
                    item.onclick = (e) => {
                        if (e.target.closest('.action-btn')) return;
                        editGuest(index);
                    };

                    // Right click for context menu
                    item.oncontextmenu = (e) => {
                        e.preventDefault();
                        showContextMenu(e, index);
                    };

                    item.innerHTML = `
                        <div class="h-10 w-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center shrink-0">
                            <span class="material-symbols-outlined font-light text-slate-400">person</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-baseline mb-0.5">
                                <h4 class="text-xs font-bold truncate text-slate-800 dark:text-white uppercase">${g.ho_ten}</h4>
                                <span class="text-[10px] text-slate-400">${g.so_phong || '---'}</span>
                            </div>
                            <p class="text-[10px] text-slate-500 truncate">${g.cccd} - ${g.ngay_birth}</p>
                            <div class="flex items-center gap-1.5 mt-1">
                                <span class="h-1.5 w-1.5 rounded-full ${statusDot}"></span>
                                <span class="text-[9px] font-bold ${statusColor} uppercase tracking-wider">${statusLabel}</span>
                            </div>
                        </div>
                        <div class="flex flex-col gap-1">
                            <button onclick="removeGuest(${index})" class="action-btn text-slate-300 hover:text-red-500 transition-colors p-1">
                                <span class="material-symbols-outlined text-lg">delete</span>
                            </button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }
            countEl.innerText = guestList.length;
        }

        function removeGuest(index) {
            if (confirm("Xóa khách này?")) {
                guestList.splice(index, 1);
                renderTable();
            }
        }

        function clearAll() {
            if (confirm("Xóa toàn bộ danh sách?")) {
                guestList = [];
                renderTable();
            }
        }

        function exportJSON() {
            if (guestList.length === 0) return alert("Trống!");
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ items: guestList }, null, 2));
            const dlAnchor = document.createElement('a');
            dlAnchor.setAttribute("href", dataStr);
            dlAnchor.setAttribute("download", `khach_${new Date().getTime()}.json`);
            dlAnchor.click();
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.items) {
                        guestList = [...guestList, ...data.items];
                        renderTable();
                    }
                } catch (err) { alert("File lỗi!"); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function sendToPython() {
            if (guestList.length === 0) return alert("Danh sách trống!");
            if (!selectedBranch) return showBranchModal();

            const errorCount = guestList.filter(g => g.status === 'ERROR').length;
            document.getElementById('totalCount').textContent = guestList.length;
            document.getElementById('errorCount').textContent = errorCount;
            document.getElementById('btnRetry').style.display = errorCount === 0 ? 'none' : 'flex';

            const modal = document.getElementById('sendConfirmModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function cancelSend() {
            const modal = document.getElementById('sendConfirmModal');
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }

        async function sendRetry() {
            const errorGuests = guestList.filter(g => g.status === 'ERROR');
            if (errorGuests.length === 0) return cancelSend();
            cancelSend();
            await performSend(errorGuests);
        }

        async function sendNew() {
            cancelSend();
            guestList.forEach(g => g.status = 'PENDING');
            renderTable();
            await performSend(guestList);
        }

        async function performSend(itemsToSend) {
            const btn = document.getElementById('sendBtn');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = `<span class="material-symbols-outlined animate-spin">sync</span> ĐANG GỬI...`;
            btn.disabled = true;

            try {
                await fetch('http://127.0.0.1:8000/send-to-web', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: itemsToSend, branch: selectedBranch })
                });
            } catch (error) {
                alert("Lỗi kết nối Automation Server!");
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        // --- WEBSOCKET ---
        const ws = new WebSocket("ws://127.0.0.1:8000/ws");
        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data.index !== undefined && guestList[data.index]) {
                    guestList[data.index].status = data.type;
                    renderTable();
                }
            } catch (e) { console.error(e); }
        };

        // --- ADDRESS DROPDOWNS ---
        async function loadProvinces() {
            try {
                const response = await fetch('https://provinces.open-api.vn/api/v2/p/');
                provincesData = await response.json();
            } catch (e) { }
        }

        function onTinhFocus() { showTinhDropdown(''); }
        function onTinhInput(e) { showTinhDropdown(e.target.value); }
        function showTinhDropdown(text) {
            const dropdown = document.getElementById('tinhDropdown');
            const filtered = provincesData.filter(p => p.name.toLowerCase().includes(text.toLowerCase()));
            if (!filtered.length) return dropdown.classList.remove('show');
            dropdown.innerHTML = filtered.map(p => `<div class="dropdown-item" onclick="selectTinh(${JSON.stringify(p).replace(/"/g, '&quot;')})">${p.name}</div>`).join('');
            dropdown.classList.add('show');
        }
        async function selectTinh(p) {
            document.getElementById('tinh').value = p.name;
            document.getElementById('tinhDropdown').classList.remove('show');
            document.getElementById('xa').value = '';
            try {
                const res = await fetch(`https://provinces.open-api.vn/api/v2/p/${p.code}?depth=2`);
                const detail = await res.json();
                wardsData = detail.wards || [];
            } catch (e) { }
        }
        function onXaFocus() { if (wardsData.length) showXaDropdown(''); }
        function onXaInput(e) { showXaDropdown(e.target.value); }
        function showXaDropdown(text) {
            const dropdown = document.getElementById('xaDropdown');
            const filtered = wardsData.filter(w => w.name.toLowerCase().includes(text.toLowerCase()));
            if (!filtered.length) return dropdown.classList.remove('show');
            dropdown.innerHTML = filtered.slice(0, 50).map(w => `<div class="dropdown-item" onclick="selectXa('${w.name}')">${w.name}</div>`).join('');
            dropdown.classList.add('show');
        }
        function selectXa(name) {
            document.getElementById('xa').value = name;
            document.getElementById('xaDropdown').classList.remove('show');
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.context-menu')) {
                hideContextMenu();
            }
            if (!e.target.closest('.dropdown-wrapper')) {
                document.getElementById('tinhDropdown').classList.remove('show');
                document.getElementById('xaDropdown').classList.remove('show');
            }
        });

        // --- CONTEXT MENU LOGIC ---
        let contextMenuIndex = -1;
        const contextMenu = document.getElementById('contextMenu');

        function showContextMenu(e, index) {
            contextMenuIndex = index;
            contextMenu.style.display = 'block';
            let x = e.clientX;
            let y = e.clientY;
            const menuWidth = 180;
            const menuHeight = 150;
            if (x + menuWidth > window.innerWidth) x -= menuWidth;
            if (y + menuHeight > window.innerHeight) y -= menuHeight;
            contextMenu.style.left = `${x}px`;
            contextMenu.style.top = `${y}px`;
        }

        function hideContextMenu() {
            contextMenu.style.display = 'none';
        }

        async function sendIndividualFromMenu() {
            if (contextMenuIndex === -1) return;
            const guest = guestList[contextMenuIndex];
            const guestWithIndex = { ...guest, index: contextMenuIndex };
            guestList[contextMenuIndex].status = 'PENDING';
            renderTable();
            await performSend([guestWithIndex]);
            hideContextMenu();
        }

        function editFromMenu() {
            if (contextMenuIndex === -1) return;
            editGuest(contextMenuIndex);
            hideContextMenu();
        }

        function removeFromMenu() {
            if (contextMenuIndex === -1) return;
            removeGuest(contextMenuIndex);
            hideContextMenu();
        }

        window.addEventListener('scroll', hideContextMenu, true);
    </script>
</body>

</html>